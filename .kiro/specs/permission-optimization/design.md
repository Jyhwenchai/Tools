# æƒé™ä¼˜åŒ–è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬è®¾è®¡æ–‡æ¡£æ—¨åœ¨è§£å†³ macOS å·¥å…·åº”ç”¨ä¸­æƒé™å¼¹çª—è¿‡äºé¢‘ç¹çš„é—®é¢˜ã€‚é€šè¿‡é‡æ–°è®¾è®¡æƒé™è¯·æ±‚ç­–ç•¥ã€å®ç°æƒé™çŠ¶æ€ç¼“å­˜ã€æä¾›åŠŸèƒ½é™çº§æ–¹æ¡ˆç­‰æ–¹å¼ï¼Œæ˜¾è‘—æ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

## æ¶æ„è®¾è®¡

### æƒé™ç§»é™¤æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Permission-Free Design                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Drag & Drop    â”‚  â”‚  File Dialogs   â”‚  â”‚  Clipboard      â”‚ â”‚
â”‚  â”‚  File Import    â”‚  â”‚  (Native)       â”‚  â”‚  (One-time)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Remove Performance Monitoring                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Minimal Code Impact                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç®€åŒ–æ¨¡å—ç»“æ„

```
Tools/
â”œâ”€â”€ Shared/
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ FileAccessService.swift          # ç®€åŒ–æ–‡ä»¶è®¿é—®æœåŠ¡
â”‚   â”‚   â””â”€â”€ ClipboardService.swift           # ç²˜è´´æ¿æœåŠ¡ï¼ˆä¸€æ¬¡æ€§æƒé™ï¼‰
â”‚   â””â”€â”€ Extensions/
â”‚       â””â”€â”€ View+FileHandling.swift          # æ–‡ä»¶å¤„ç†æ‰©å±•
â”œâ”€â”€ Features/
â”‚   â”œâ”€â”€ ImageProcessing/
â”‚   â”‚   â””â”€â”€ Views/
â”‚   â”‚       â””â”€â”€ DragDropImageView.swift      # æ‹–æ‹½å¯¼å…¥ç•Œé¢
â”‚   â””â”€â”€ Clipboard/
â”‚       â””â”€â”€ Services/
â”‚           â””â”€â”€ SimpleClipboardService.swift # ç®€åŒ–ç²˜è´´æ¿æœåŠ¡
â””â”€â”€ Core/
    â””â”€â”€ Utils/
        â””â”€â”€ FileDialogUtils.swift            # æ–‡ä»¶å¯¹è¯æ¡†å·¥å…·
```

## ç»„ä»¶å’Œæ¥å£è®¾è®¡

### ç®€åŒ–æ–‡ä»¶è®¿é—®æœåŠ¡

```swift
@Observable
class FileAccessService {
  // å®Œå…¨ç§»é™¤æƒé™æ£€æŸ¥ï¼Œåªä½¿ç”¨ç³»ç»ŸåŸç”Ÿå¯¹è¯æ¡†å’Œæ‹–æ‹½
  func importFile() async -> URL? {
    // ä½¿ç”¨ç³»ç»ŸåŸç”Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼Œæ— éœ€æƒé™
    return await showFileDialog()
  }
  
  func exportFile(data: Data, suggestedName: String) async -> Bool {
    // ä½¿ç”¨ç³»ç»ŸåŸç”Ÿä¿å­˜å¯¹è¯æ¡†ï¼Œæ— éœ€æƒé™
    return await showSaveDialog(data: data, suggestedName: suggestedName)
  }
  
  // å¤„ç†æ‹–æ‹½å¯¼å…¥
  func handleDraggedFiles(_ urls: [URL]) -> [URL] {
    return urls.filter { $0.isFileURL }
  }
}
```

### ä¸€æ¬¡æ€§ç²˜è´´æ¿æƒé™å¤„ç†

```swift
@Observable
class ClipboardService {
  @AppStorage("clipboardPermissionGranted") private var permissionGranted = false
  @AppStorage("clipboardPermissionAsked") private var permissionAsked = false
  
  private var isEnabled: Bool {
    return permissionGranted
  }
  
  // ä¸€æ¬¡æ€§æƒé™è¯·æ±‚
  func requestPermissionIfNeeded() async {
    guard !permissionAsked else { return }
    
    permissionAsked = true
    let granted = await requestClipboardAccess()
    permissionGranted = granted
  }
  
  // ç®€åŒ–çš„ç²˜è´´æ¿æ“ä½œ
  func addToHistory(_ content: String) {
    guard isEnabled else { return }
    // æ·»åŠ åˆ°å†å²è®°å½•
  }
  
  func getHistory() -> [ClipboardItem] {
    guard isEnabled else { return [] }
    // è¿”å›å†å²è®°å½•
  }
}
```

### ä¿ç•™å¼€å‘æœŸé—´æ€§èƒ½ç›‘æ§

```swift
@Observable
class PerformanceMonitorService {
  private var isDebugMode: Bool {
    #if DEBUG
    return true
    #else
    return false
    #endif
  }
  
  // åªåœ¨å¼€å‘æ¨¡å¼ä¸‹è¿›è¡Œæ€§èƒ½ç›‘æ§ï¼Œä¸è¯·æ±‚æƒé™
  func logPerformanceMetrics() {
    guard isDebugMode else { return }
    
    // ä½¿ç”¨ä¸éœ€è¦æƒé™çš„æ–¹å¼è·å–åŸºæœ¬æ€§èƒ½ä¿¡æ¯
    let memoryUsage = getBasicMemoryInfo()
    let cpuUsage = getBasicCPUInfo()
    
    print("ğŸ” Performance - Memory: \(memoryUsage)MB, CPU: \(cpuUsage)%")
  }
  
  // è·å–åŸºæœ¬å†…å­˜ä¿¡æ¯ï¼ˆä¸éœ€è¦ç‰¹æ®Šæƒé™ï¼‰
  private func getBasicMemoryInfo() -> Double {
    let info = mach_task_basic_info()
    var count = mach_msg_type_number_t(MemoryLayout<mach_task_basic_info>.size)/4
    
    let kerr: kern_return_t = withUnsafeMutablePointer(to: &info) {
      $0.withMemoryRebound(to: integer_t.self, capacity: 1) {
        task_info(mach_task_self_, task_flavor_t(MACH_TASK_BASIC_INFO), $0, &count)
      }
    }
    
    if kerr == KERN_SUCCESS {
      return Double(info.resident_size) / 1024.0 / 1024.0
    }
    return 0
  }
  
  // è·å–åŸºæœ¬CPUä¿¡æ¯ï¼ˆä¸éœ€è¦ç‰¹æ®Šæƒé™ï¼‰
  private func getBasicCPUInfo() -> Double {
    // ä½¿ç”¨åŸºæœ¬çš„CPUä½¿ç”¨ç‡è·å–æ–¹æ³•
    // è¿™é‡Œå¯ä»¥å®ç°ç®€å•çš„CPUä½¿ç”¨ç‡è®¡ç®—
    return 0.0 // å ä½ç¬¦
  }
}

// ç§»é™¤ç”¨æˆ·ç•Œé¢çš„æ€§èƒ½ç›‘æ§æ˜¾ç¤º
struct PerformanceView: View {
  var body: some View {
    // åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­éšè—æ€§èƒ½ç›‘æ§UI
    #if DEBUG
    VStack {
      Text("å¼€å‘æ¨¡å¼ - æ€§èƒ½ç›‘æ§")
        .font(.caption)
        .foregroundColor(.secondary)
      Text("æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è·å–æ€§èƒ½ä¿¡æ¯")
        .font(.caption2)
        .foregroundColor(.secondary)
    }
    #else
    EmptyView()
    #endif
  }
}
```

### æ‹–æ‹½å¯¼å…¥ç•Œé¢

```swift
struct DragDropImageView: View {
  @State private var draggedImage: NSImage?
  @State private var isTargeted = false
  
  var body: some View {
    RoundedRectangle(cornerRadius: 12)
      .fill(isTargeted ? Color.blue.opacity(0.1) : Color.gray.opacity(0.1))
      .overlay(
        VStack {
          Image(systemName: "photo.badge.plus")
            .font(.system(size: 48))
            .foregroundColor(.secondary)
          
          Text("æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„")
            .font(.headline)
            .foregroundColor(.secondary)
          
          Text("æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶")
            .font(.caption)
            .foregroundColor(.secondary)
        }
      )
      .onDrop(of: [.fileURL], isTargeted: $isTargeted) { providers in
        handleDrop(providers)
      }
      .onTapGesture {
        showFileDialog()
      }
  }
  
  private func handleDrop(_ providers: [NSItemProvider]) -> Bool {
    // å¤„ç†æ‹–æ‹½å¯¼å…¥ï¼Œæ— éœ€æƒé™
    for provider in providers {
      provider.loadItem(forTypeIdentifier: "public.file-url") { item, error in
        if let data = item as? Data,
           let url = URL(dataRepresentation: data, relativeTo: nil) {
          loadImage(from: url)
        }
      }
    }
    return true
  }
  
  private func showFileDialog() {
    // ä½¿ç”¨ç³»ç»ŸåŸç”Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼Œæ— éœ€æƒé™
    let panel = NSOpenPanel()
    panel.allowedContentTypes = [.image]
    panel.allowsMultipleSelection = false
    
    if panel.runModal() == .OK,
       let url = panel.url {
      loadImage(from: url)
    }
  }
}
```

### æ–‡ä»¶å¯¹è¯æ¡†å·¥å…·

```swift
struct FileDialogUtils {
  static func showOpenDialog(allowedTypes: [UTType]) async -> URL? {
    return await withCheckedContinuation { continuation in
      DispatchQueue.main.async {
        let panel = NSOpenPanel()
        panel.allowedContentTypes = allowedTypes
        panel.allowsMultipleSelection = false
        
        let result = panel.runModal()
        continuation.resume(returning: result == .OK ? panel.url : nil)
      }
    }
  }
  
  static func showSaveDialog(suggestedName: String, allowedTypes: [UTType]) async -> URL? {
    return await withCheckedContinuation { continuation in
      DispatchQueue.main.async {
        let panel = NSSavePanel()
        panel.allowedContentTypes = allowedTypes
        panel.nameFieldStringValue = suggestedName
        
        let result = panel.runModal()
        continuation.resume(returning: result == .OK ? panel.url : nil)
      }
    }
  }
}

## æ•°æ®æ¨¡å‹

### ç®€åŒ–é…ç½®

```swift
struct AppConfiguration {
  // ç²˜è´´æ¿æƒé™çŠ¶æ€å­˜å‚¨é”®
  static let clipboardPermissionKey = "clipboardPermissionGranted"
  static let clipboardAskedKey = "clipboardPermissionAsked"
  
  // æ–‡ä»¶ç±»å‹æ”¯æŒ
  static let supportedImageTypes: [UTType] = [.png, .jpeg, .gif, .tiff, .bmp]
  static let supportedExportTypes: [UTType] = [.png, .jpeg]
}
```

### ç®€åŒ–ç²˜è´´æ¿æ¨¡å‹

```swift
struct ClipboardItem: Identifiable, Codable {
  let id = UUID()
  let content: String
  let timestamp: Date
  let type: ClipboardItemType
  
  enum ClipboardItemType: String, Codable, CaseIterable {
    case text = "æ–‡æœ¬"
    case url = "é“¾æ¥"
    case code = "ä»£ç "
  }
}

// ç§»é™¤å¤æ‚çš„æƒé™çŠ¶æ€æ¨¡å‹
// åªä¿ç•™å¿…è¦çš„æ•°æ®ç»“æ„

## é”™è¯¯å¤„ç†

### ç®€åŒ–é”™è¯¯å¤„ç†

```swift
enum FileAccessError: LocalizedError {
  case fileNotFound
  case unsupportedFormat
  case saveFailed
  
  var errorDescription: String? {
    switch self {
    case .fileNotFound:
      return "æ–‡ä»¶æœªæ‰¾åˆ°"
    case .unsupportedFormat:
      return "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼"
    case .saveFailed:
      return "æ–‡ä»¶ä¿å­˜å¤±è´¥"
    }
  }
}

// ç§»é™¤æ‰€æœ‰æƒé™ç›¸å…³çš„é”™è¯¯å¤„ç†
// ç®€åŒ–é”™è¯¯ç±»å‹ï¼Œåªä¿ç•™æ ¸å¿ƒåŠŸèƒ½ç›¸å…³çš„é”™è¯¯

## å®æ–½ç­–ç•¥

### æƒé™è¯·æ±‚ä¼˜åŒ–ç­–ç•¥

1. **å»¶è¿Ÿè¯·æ±‚**: åªåœ¨ç”¨æˆ·çœŸæ­£ä½¿ç”¨ç›¸å…³åŠŸèƒ½æ—¶æ‰è¯·æ±‚æƒé™
2. **æ‰¹é‡è¯·æ±‚**: å°†ç›¸å…³æƒé™åˆå¹¶åœ¨ä¸€æ¬¡ç”¨æˆ·äº¤äº’ä¸­è¯·æ±‚
3. **ç¼“å­˜çŠ¶æ€**: ç¼“å­˜æƒé™çŠ¶æ€ï¼Œé¿å…é‡å¤æ£€æŸ¥
4. **ä¼˜é›…é™çº§**: æƒé™è¢«æ‹’ç»æ—¶æä¾›æ›¿ä»£æ–¹æ¡ˆ

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–

1. **æ¸…æ™°è¯´æ˜**: åœ¨è¯·æ±‚æƒé™å‰è¯´æ˜ç”¨é€”å’Œå½±å“
2. **å¯é€‰åŠŸèƒ½**: å°†éæ ¸å¿ƒåŠŸèƒ½çš„æƒé™è®¾ä¸ºå¯é€‰
3. **æ›¿ä»£æ–¹æ¡ˆ**: ä¸ºæƒé™å—é™çš„åŠŸèƒ½æä¾›æ›¿ä»£æ“ä½œæ–¹å¼
4. **ç»Ÿä¸€ç®¡ç†**: æä¾›ç»Ÿä¸€çš„æƒé™ç®¡ç†ç•Œé¢

### æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥å¤„ç†**: æƒé™æ£€æŸ¥å’Œè¯·æ±‚éƒ½åœ¨åå°çº¿ç¨‹è¿›è¡Œ
2. **ç¼“å­˜æœºåˆ¶**: é¿å…é¢‘ç¹çš„ç³»ç»Ÿæƒé™çŠ¶æ€æŸ¥è¯¢
3. **èµ„æºæ¸…ç†**: åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æƒé™ç›‘å¬å’Œç¼“å­˜
4. **æ¡ä»¶åŠ è½½**: åªåœ¨éœ€è¦æ—¶åŠ è½½æƒé™ç›¸å…³çš„æœåŠ¡

## æµ‹è¯•ç­–ç•¥

### æƒé™æµ‹è¯•åœºæ™¯

1. **æƒé™çŠ¶æ€æµ‹è¯•**: æµ‹è¯•å„ç§æƒé™çŠ¶æ€ä¸‹çš„åº”ç”¨è¡Œä¸º
2. **é™çº§åŠŸèƒ½æµ‹è¯•**: æµ‹è¯•æƒé™è¢«æ‹’ç»æ—¶çš„æ›¿ä»£æ–¹æ¡ˆ
3. **ç¼“å­˜æœºåˆ¶æµ‹è¯•**: æµ‹è¯•æƒé™çŠ¶æ€ç¼“å­˜çš„æœ‰æ•ˆæ€§
4. **ç”¨æˆ·ä½“éªŒæµ‹è¯•**: æµ‹è¯•æƒé™è¯·æ±‚çš„ç”¨æˆ·äº¤äº’æµç¨‹

### æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

```swift
struct PermissionManagerTests {
  
  @Test("æƒé™çŠ¶æ€ç¼“å­˜æµ‹è¯•")
  func testPermissionStateCache() async {
    let manager = PermissionManager()
    
    // é¦–æ¬¡æ£€æŸ¥åº”è¯¥æŸ¥è¯¢ç³»ç»ŸçŠ¶æ€
    let initialState = manager.checkPermissionStatus(.fileAccess)
    
    // ç¬¬äºŒæ¬¡æ£€æŸ¥åº”è¯¥ä½¿ç”¨ç¼“å­˜
    let cachedState = manager.checkPermissionStatus(.fileAccess)
    
    #expect(initialState == cachedState)
  }
  
  @Test("æƒé™æ‹’ç»åçš„é™çº§å¤„ç†")
  func testGracefulDegradation() async {
    let service = FileAccessService(permissionManager: PermissionManager())
    
    // æ¨¡æ‹Ÿæƒé™è¢«æ‹’ç»çš„æƒ…å†µ
    let result = await service.accessFile()
    
    // åº”è¯¥è¿”å›æ›¿ä»£æ–¹æ¡ˆ
    #expect(result == .requiresDragAndDrop)
  }
}
```